# Raspilapse Configuration File (Example/Template)
#
# IMPORTANT: This is the default configuration template.
#            Copy this file to config.yml and customize it:
#            cp config/config.example.yml config/config.yml
#
# Your config.yml will NOT be tracked by git, so you can safely
# customize it with your personal settings (API keys, paths, etc.)

# Location Settings (for sun position calculation)
# Used for Polar Day/Night detection at high latitudes (68°N)
# This enables "Civil Twilight Override" - forces Day mode when sun > -6°
location:
  # Latitude in decimal degrees (negative for South)
  latitude: 68.7
  # Longitude in decimal degrees (negative for West)
  longitude: 15.4
  # Timezone (for accurate sun calculations)
  timezone: "Europe/Oslo"
  # Civil twilight threshold (degrees below horizon)
  # Sun > this value = force Day mode even if lux is low
  civil_twilight_threshold: -6.0

# Camera Settings
camera:
  # Image resolution (width x height)
  # Common options for Camera V3:
  # - [4608, 2592] - Full 11.9MP
  # - [2304, 1296] - 3MP binned
  # - [1920, 1080] - Full HD
  # - [1280, 720]  - HD
  resolution:
    width: 3840
    height: 2160

  # Image transforms
  transforms:
    horizontal_flip: false
    vertical_flip: false

  # Camera controls (optional, comment out for auto)
  controls:
    # Exposure time in microseconds (e.g., 20000 = 20ms)
    # exposure_time: 20000

    # Analogue gain (1.0 = normal)
    # analogue_gain: 1.0

    # Auto white balance enable
    # awb_enable: true

    # Manual colour gains (if awb disabled)
    # colour_gains: [1.5, 1.5]

    # Brightness (-1.0 to 1.0, 0 = normal)
    # brightness: 0.0

    # Contrast (0.0 to 2.0, 1.0 = normal)
    # contrast: 1.0

    # Autofocus mode (if supported):
    # 0 = Manual, 1 = Single AF, 2 = Continuous AF
    # af_mode: 2

    # Lens position (focus) - only used when af_mode = 0 (Manual)
    # Value in dioptres (1/distance in meters):
    # 0.0 = infinity focus (distant objects)
    # 1.0 = focus at 1 meter
    # 10.0 = focus at 10cm (close-up)
    # Note: Values are approximate and vary by module/temperature
    # lens_position: 0.0

# Output Settings
output:
  # Base directory for saved images
  # For production timelapse, use: /var/www/html/images
  # For testing, use: test_photos
  directory: "/var/www/html/images"

  # Filename pattern (supports strftime formatting and counter)
  # Available placeholders:
  # - {timestamp} - ISO format timestamp
  # - {counter} - Sequential counter (4 digits, zero-padded)
  # - {name} - Project name
  # You can also use strftime directives like %Y%m%d_%H%M%S
  filename_pattern: "{name}_%Y_%m_%d_%H_%M_%S.jpg"

  # Project name (used in filename)
  project_name: "timelapse"

  # Image quality (0-100, JPEG compression)
  # Higher = better quality, larger files
  quality: 75

  # Create subdirectories by date (YEAR/MONTH/DAY structure)
  # When enabled, images are organized as: directory/YYYY/MM/DD/filename.jpg
  # Example: /var/www/html/images/2025/11/05/kringelen_2025_11_05_14_30_00.jpg
  organize_by_date: true

  # Date format for subdirectories (if organize_by_date is true)
  # %Y = 4-digit year, %m = 2-digit month, %d = 2-digit day
  date_format: "%Y/%m/%d"

  # Symlink latest image (for web status display)
  symlink_latest:
    enabled: true
    path: "/var/www/html/status.jpg"

# Video Output Settings
video:
  # Base directory for generated timelapse videos
  directory: "/var/www/html/videos"

  # Create subdirectories by date (YEAR/MONTH structure)
  # When enabled, videos are organized as: directory/YYYY/MM/filename.mp4
  # Example: /var/www/html/videos/2025/12/timelapse_daily_2025-12-23.mp4
  organize_by_date: true

  # Date format for subdirectories (if organize_by_date is true)
  # %Y = 4-digit year, %m = 2-digit month
  date_format: "%Y/%m"

  # Video filename pattern (supports strftime formatting)
  # Available placeholders:
  # - {name} - Project name
  # - {start_date} - Start date (YYYY-MM-DD)
  # - {end_date} - End date (YYYY-MM-DD)
  # You can also use strftime directives like %Y%m%d
  filename_pattern: "{name}_{start_date}_to_{end_date}.mp4"

  # Video codec settings
  codec:
    # Video codec: libx264 (software H.264 encoder)
    # Note: h264_v4l2m2m hardware encoder doesn't support 4K on Pi
    name: "libx264"

    # Pixel format (yuv420p for maximum compatibility)
    pixel_format: "yuv420p"

    # Preset for libx264 (affects speed vs quality vs memory)
    # ultrafast = fastest, lowest memory, acceptable quality
    # fast = good balance (recommended)
    # slow = best quality, highest memory (may OOM on 4K)
    preset: "fast"

    # Thread count (lower = less memory, slower encoding)
    # 2 = safe for Pi with 4GB RAM doing 4K
    threads: 2

    # Constant Rate Factor (0-51, lower = better quality)
    # 18 = visually lossless, 23 = good quality, 25 = good balance, 28 = acceptable
    crf: 25

  # Frame rate (frames per second)
  # 25 fps = smooth European standard
  # 30 fps = smooth NTSC standard
  # 24 fps = cinematic
  fps: 25

  # Deflicker filter - smooths exposure transitions (like sunrise spikes)
  # Uses ffmpeg's deflicker filter with Predictive Mean mode
  deflicker: true
  # Number of frames to average for deflicker (higher = smoother but may blur fast changes)
  deflicker_size: 10

  # Default time range for timelapse generation (used when no --start/--end provided)
  # Format: HH:MM
  # If end time <= start time, assumes start is from previous day
  # Example: start 05:00, end 05:00 = yesterday 05:00 to today 05:00 (24h)
  default_start_time: "05:00"
  # End time (comment out or set to null to use current time)
  default_end_time: "05:00"

# Timelapse Settings (for future timelapse.py script)
timelapse:
  # Interval between captures in seconds
  interval: 3

  # Total number of frames to capture (0 = unlimited)
  num_frames: 0

  # Stabilization delay after camera start (seconds)
  stabilization_delay: 2

# Adaptive Timelapse Settings (for auto_timelapse.py)
adaptive_timelapse:
  # Enable adaptive exposure based on light conditions
  enabled: true

  # Reference lux - controls overall image brightness
  # Higher = brighter images, Lower = darker images
  # Tune per-camera based on scene and sensor sensitivity
  # Typical range: 2.5 (darker) to 4.5 (brighter), default 3.8
  reference_lux: 3.8

  # Interval between captures in seconds
  interval: 30

  # Total number of frames to capture (0 = unlimited, runs continuously)
  num_frames: 0

  # Light level thresholds (based on calculated lux from metadata)
  # These values determine when to switch between day/night/transition modes
  light_thresholds:
    # Lux below this = night mode (long exposure)
    # Lower values = transition starts earlier (prevents morning overexposure)
    # Recommended: 3 (starts transition before sky gets too bright)
    night: 3

    # Lux above this = day mode (normal exposure)
    day: 80

    # Between night and day = transition mode (gradual adjustment)
    # Automatically calculated between night and day thresholds

  # Night mode settings (for dark conditions - stars, aurora, etc.)
  night_mode:
    # Maximum exposure time in seconds (max 20 seconds to avoid star trails)
    max_exposure_time: 20.0

    # Analogue gain (ISO equivalent)
    # Higher = brighter but more noise. Range: 1.0-8.0, recommended max: 4.0
    analogue_gain: 6

    # Use auto white balance in night mode
    awb_enable: false

    # Manual color gains if awb disabled (red, blue)
    #colour_gains: [1.8, 1.5]
    colour_gains: [1.83, 2.02]

  # Day mode settings (for bright daylight conditions)
  day_mode:
    # Target exposure time in seconds for bright daylight
    # Used when smooth_exposure_in_day_mode is enabled
    exposure_time: 0.01  # 10ms for bright conditions

    # Target analogue gain for daylight (lower = less noise)
    # Used when smooth_exposure_in_day_mode is enabled
    analogue_gain: 1.0  # Minimum gain for bright conditions

    # Fixed white balance gains for day mode (red, blue)
    # When specified, uses these fixed gains instead of learning from AWB
    # Recommended for consistent color across sessions
    # Comment out to learn from camera's AWB instead
    # fixed_colour_gains: [2.5, 1.6]

    # Use auto white balance in day mode
    awb_enable: true

    # Brightness adjustment (-1.0 to 1.0)
    # Negative = darker, positive = brighter
    # 0.0 = no adjustment (camera default auto-exposure)
    # brightness: 0.0

  # Transition mode settings (dawn/dusk)
  transition_mode:
    # Gradually adjust between day and night settings
    # Based on calculated lux value
    smooth_transition: true

    # === SEQUENTIAL RAMPING (Noise Reduction) ===
    # When enabled, prioritizes shutter speed over gain to minimize noise:
    # - Phase 1: Ramp shutter from day value to max, keep gain locked at ~1.0
    # - Phase 2: Only after shutter is maxed, ramp gain up to night target
    # This produces cleaner twilight images by keeping ISO low as long as possible
    sequential_ramping: true

    # === SMOOTH TRANSITION SETTINGS ===
    # These settings prevent flickering and ISO jumps during day/night transitions

    # Lux smoothing factor (exponential moving average)
    # Lower = smoother but slower response (0.1-0.5 recommended)
    # Higher = faster response but more jitter
    lux_smoothing_factor: 0.3

    # Hysteresis frames: number of consecutive frames required before mode change
    # Prevents rapid flipping between modes when lux is near threshold
    # Higher = more stable but slower transitions (2-5 recommended)
    hysteresis_frames: 3

    # White balance transition speed (0.0-1.0)
    # How quickly WB gains change towards target per frame
    # Lower = smoother color transitions (0.1-0.2 recommended)
    # Higher = faster but may show color jumps
    wb_transition_speed: 0.15

    # Gain (ISO) transition speed (0.0-1.0)
    # How quickly gain changes towards target per frame
    # Lower = smoother ISO transitions (0.05-0.15 recommended)
    # Higher = faster but may show brightness jumps
    gain_transition_speed: 0.10

    # Exposure time transition speed (0.0-1.0)
    # How quickly exposure changes towards target per frame
    # Uses logarithmic interpolation for natural brightness changes
    # Lower = smoother transitions (0.05-0.15 recommended)
    exposure_transition_speed: 0.10

    # Use smooth WB interpolation even in day mode
    # When true, always uses manual WB gains (interpolated)
    # When false, uses camera's AWB in full day mode (legacy behavior)
    smooth_wb_in_day_mode: true

    # Use smooth exposure/gain in day mode
    # When true, calculates exposure and gain based on lux (prevents ISO jumps)
    # When false, uses camera's auto-exposure (legacy behavior, may cause ISO jumps)
    smooth_exposure_in_day_mode: true

    # === BRIGHTNESS FEEDBACK SETTINGS ===
    # These settings enable real-time brightness correction for butter-smooth
    # transitions. The system analyzes actual image brightness and gradually
    # adjusts exposure to maintain consistent brightness.

    # Enable brightness feedback (recommended for smooth transitions)
    brightness_feedback_enabled: true

    # Target brightness (0-255, where 128 is mid-gray)
    # Higher = brighter images, lower = darker images
    target_brightness: 120

    # Brightness tolerance (pixels within target ± tolerance are acceptable)
    # Larger tolerance = less correction, more stable
    # Smaller tolerance = more correction, may cause subtle fluctuations
    brightness_tolerance: 40

    # Brightness feedback strength (0.0-1.0)
    # How quickly the correction factor adjusts per frame
    # Lower = smoother but slower to correct (recommended: 0.1-0.3)
    # Higher = faster correction but may cause subtle jumps
    brightness_feedback_strength: 0.2

    # === OVEREXPOSURE FAST RAMP-DOWN ===
    # When overexposure is detected (brightness > 180 or >10% clipped pixels),
    # exposure ramps down faster to prevent the "light flash" at dawn.
    # This speed replaces the normal exposure_transition_speed temporarily.
    #
    # fast_rampdown_speed (0.1-0.5)
    # - 0.30 = 3x faster than normal (conservative)
    # - 0.40 = 4x faster (moderate)
    # - 0.50 = 5x faster (recommended for quick overexposure correction)
    fast_rampdown_speed: 0.50

    # === EV SAFETY CLAMP ===
    # Prevents brightness jumps when transitioning from day (auto) to night (manual) mode.
    # Uses the "Holy Grail" technique: seeds manual exposure from last auto-exposure values.
    #
    # IMPORTANT: Disable this for scenes with bright point light sources (street lamps,
    # security lights, etc.) as they can fool the auto-exposure seeding and cause
    # extremely short exposures (e.g., 330ms instead of 20s) in night mode.
    #
    # When enabled: First manual frame matches last auto frame exactly (no brightness jump)
    # When disabled: Manual exposure calculated purely from lux (may have slight jump but
    #                works correctly with bright point light sources in frame)
    #
    # ev_safety_clamp_enabled: true (default) - Enable for scenes without bright point lights
    # ev_safety_clamp_enabled: false - Disable for scenes with street lamps, etc.
    ev_safety_clamp_enabled: true

  # Test shot settings (used to measure light levels)
  test_shot:
    # Take a test shot before each capture to measure light
    enabled: true

    # Test shot exposure time in seconds (quick test)
    exposure_time: 0.1

    # Test shot gain
    analogue_gain: 1.0

    # Measurement frequency: how often to take test shots
    # 1 = every capture (default), 2 = every other capture, etc.
    # Higher values reduce overhead but may miss rapid light changes
    # Recommended: 1 for dawn/dusk transitions, 2-3 for stable lighting
    frequency: 1

  # Diagnostic metadata settings
  # Adds extra analysis data to each capture's metadata JSON
  diagnostics:
    # Enable diagnostic metadata (target vs actual exposure/gain, brightness analysis)
    # Useful for debugging and tuning transition settings
    # Adds ~100-300ms processing per capture (image brightness analysis)
    enabled: false

# System Settings
system:
  # Create output directory if it doesn't exist
  create_directories: true

  # Save metadata with each capture
  save_metadata: true

  # Metadata filename pattern
  metadata_filename: "{name}_%Y_%m_%d_%H_%M_%S_metadata.json"

  # Metadata folder for test shots (overwritten each time)
  metadata_folder: "metadata"

# Overlay Settings
overlay:
  # Enable/disable overlay
  enabled: true

  # Font settings
  font:
    # Font family (system font name or path to .ttf file)
    # Common: "DejaVuSans.ttf", "DejaVuSans-Bold.ttf", "Arial.ttf"
    # Leave as "default" to use PIL default font
    family: "DejaVuSans-Bold.ttf"  # Bold for sharper, clearer text

    # Font size relative to image height (0.02 = 2% of image height)
    size_ratio: 0.020  # Slightly larger for bar mode

    # Font color (RGB or RGBA)
    color: [255, 255, 255, 255]  # Pure white with full opacity

  # Background settings for text
  background:
    # Enable semi-transparent background behind text
    enabled: true

    # Background color (RGBA - last value is opacity: 0=transparent, 255=opaque)
    # For top-bar mode, this creates a gradient that fades out at the bottom
    color: [0, 0, 30, 70]  # Black with 43% opacity (very transparent with gradient)

    # Padding around text (relative to font size)
    padding: 0.6  # Extra padding for more breathing room

  # Position presets: "top-left", "top-right", "bottom-left", "bottom-right", "top-bar", "custom"
  # "top-bar" creates a full-width navbar at top with centered text
  position: "top-bar"

  # Custom position (only used if position = "custom")
  # Values are percentages of image dimensions (0-100)
  custom_position:
    x: 5  # 5% from left
    y: 95  # 95% from top (near bottom)

  # Margin from edges (pixels)
  margin: 10  # Small margin for top-bar mode

  # Content to display
  # In top-bar mode: 2 lines with left/right alignment
  # In corner modes: stacked lines in a box
  #
  # Available variables for templates:
  #   {date} - Date (YYYY-MM-DD)
  #   {time} - Time (HH:MM:SS)
  #   {datetime} - Full datetime
  #   {camera_name} - Camera name from config
  #   {mode} - Light mode (day/night/transition)
  #   {exposure} - Exposure time (human readable)
  #   {exposure_ms} - Exposure time in milliseconds
  #   {exposure_us} - Exposure time in microseconds
  #   {iso} - ISO/Analogue gain
  #   {gain} - Analogue gain (raw value)
  #   {wb} - White balance mode (auto/manual)
  #   {wb_gains} - White balance gains (R, B)
  #   {lux} - Calculated lux value
  #   {resolution} - Image resolution
  #   {temperature} - Camera sensor temperature (hardware, NOT ambient)
  #   {af_mode} - Autofocus mode (Manual/Auto/Continuous)
  #   {lens_position} - Lens position in dioptres (e.g., "0.00", "10.50")
  #   {focus_distance} - Calculated focus distance (e.g., "∞", "1.5m", "10cm")
  #
  # Weather variables (requires weather.enabled = true):
  #   {temp} or {temperature_outdoor} - Outdoor temperature
  #   {humidity} - Outdoor humidity
  #   {wind} - Wind speed with gust (e.g., "5.2 m/s (gust 8.1)")
  #   {wind_speed} - Wind speed only
  #   {wind_gust} - Wind gust speed
  #   {wind_dir} - Wind direction (N, NE, E, SE, S, SW, W, NW)
  #   {rain} - Current rain
  #   {rain_1h} - Rain in last hour
  #   {rain_24h} - Rain in last 24 hours
  #   {pressure} - Atmospheric pressure
  #
  # System monitoring variables (always available):
  #   {cpu_temp} - CPU temperature (e.g., "42.5°C")
  #   {cpu_temp_raw} - CPU temperature raw value (e.g., "42.5")
  #   {disk} - Disk space formatted (e.g., "50.2 GB free (42% used)")
  #   {disk_free} - Free disk space (e.g., "50.2 GB")
  #   {disk_used} - Used disk space (e.g., "36.8 GB")
  #   {disk_total} - Total disk space (e.g., "116.7 GB")
  #   {disk_percent} - Disk usage percentage (e.g., "31%")
  #   {memory} - Memory usage formatted (e.g., "1.2 GB / 4.0 GB (30%)")
  #   {memory_used} - Used memory (e.g., "1.2 GB")
  #   {memory_free} - Free memory (e.g., "2.8 GB")
  #   {memory_total} - Total memory (e.g., "4.0 GB")
  #   {memory_percent} - Memory usage percentage (e.g., "30%")
  #   {load} - CPU load averages (e.g., "0.52, 0.48, 0.45")
  #   {load_1min} - 1-minute load average (e.g., "0.52")
  #   {load_5min} - 5-minute load average (e.g., "0.48")
  #   {load_15min} - 15-minute load average (e.g., "0.45")
  #   {uptime} - System uptime (e.g., "2d 5h 30m")
  content:
    # Line 1 - Left side
    line_1_left: "{camera_name}"

    # Line 1 - Right side
    line_1_right: "{temp}, humidity: {humidity}, wind: {wind} {wind_dir}, rain: {rain} "

    # Line 2 - Left side
    line_2_left: "{date} {time}"

    # Line 2 - Right side
    line_2_right: "Exposure: {exposure}, {iso}, lux: {lux} - CPU: {cpu_temp}, load: {load_1min}, disk: {disk_free}, mem: {memory_percent}"

    # Example with system monitoring:
    # line_1_right: "CPU: {cpu_temp}, Disk: {disk_free}, Load: {load_1min}"
    # line_2_right: "Memory: {memory_used}/{memory_total}, Uptime: {uptime}"

  # Camera name (displayed in overlay)
  camera_name: "Raspberry Pi Timelapse Camera 01"

  # DateTime formatting
  datetime:
    # Use localized date/time format (day name, month name in local language)
    localized: true

    # Locale for date/time formatting (e.g., "nb_NO" for Norwegian, "en_US" for English)
    # Must be installed on system: locale -a to list available
    locale: "nb_NO.UTF-8"

    # Show seconds in time
    show_seconds: false

    # Date format (when localized=false)
    # Strftime format: %Y-%m-%d = 2025-11-05
    date_format: "%Y-%m-%d"

    # Time format (when localized=false)
    # Strftime format: %H:%M:%S = 15:45:30, %H:%M = 15:45
    time_format: "%H:%M"

  # Layout options
  layout:
    # Line spacing multiplier (1.0 = normal, 1.5 = 1.5x spacing)
    line_spacing: 1.2  # Tighter spacing for bar mode

    # Separate sections with blank line
    section_spacing: false  # No blank lines in compact bar

    # Extra bottom spacing for bar (adds padding below text)
    bottom_padding_multiplier: 0.7  # 30% more space at bottom

# Logging Settings
logging:
  # Enable/disable logging
  enabled: true

  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"

  # Log file path (relative to project root)
  # Use {script} placeholder for script name
  log_file: "logs/{script}.log"

  # Log format
  # Available placeholders: %(asctime)s, %(name)s, %(levelname)s, %(message)s
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  # Date format for timestamps
  date_format: "%Y-%m-%d %H:%M:%S"

  # Also log to console
  console: true

  # Maximum log file size in MB (0 = unlimited)
  max_size_mb: 10

  # Number of backup log files to keep
  backup_count: 5

# Analysis and Graphs Settings
graphs:
  # Directory for generated analysis graphs
  directory: "graphs"

  # Graph image settings
  width: 14  # inches
  height: 8  # inches
  dpi: 150   # resolution (dots per inch)

  # Default time window for analysis (hours)
  default_hours: 24

# Video Upload Settings (for daily_timelapse.py)
video_upload:
  # Enable/disable automatic upload after timelapse creation
  enabled: false

  # Server endpoint URL for video uploads
  url: "https://example.com/api/video/upload"

  # API key for authentication (Bearer token)
  api_key: "your-api-key-here"

  # Camera ID for the upload (used to identify this camera on the server)
  camera_id: "camera_01"

# Weather Data Settings
weather:
  # Enable/disable weather data fetching
  enabled: false

  # Netatmo API endpoint URL
  # Example: "http://nesthus2026.local/api/netatmo/stations/d7bb2025-0a6e-4cf5-bbc3-9e2b4dfb1bb4"
  endpoint:

  # Cache duration in seconds (how long to keep weather data before refreshing)
  cache_duration: 300  # 5 minutes

  # Request timeout in seconds
  timeout: 5

# Database Settings (for capture history storage)
database:
  # Enable/disable SQLite database storage for capture metadata
  enabled: true

  # Path to database file (relative to project root or absolute)
  path: "data/timelapse.db"

  # Automatically create directories if they don't exist
  create_directories: true

# Barentswatch Ship Tracking Overlay
# Shows ships in the camera's field of view (from pi-overlay-data service)
barentswatch:
  # Enable/disable ship overlay
  enabled: false

  # Path to ships_current.json from pi-overlay-data service
  ships_file: "/www/pi-overlay-data/data/ships_current.json"

# Tide Data Overlay
# Shows tide information in the overlay (from pi-overlay-data service)
tide:
  # Enable/disable tide overlay
  enabled: false

  # Path to tide.json from pi-overlay-data service
  tide_file: "/www/pi-overlay-data/data/tide.json"

# Aurora Data Overlay
# Shows aurora/space weather information in the overlay (from pi-overlay-data service)
aurora:
  # Enable/disable aurora overlay
  enabled: false

  # Path to aurora.json from pi-overlay-data service
  aurora_file: "/www/pi-overlay-data/data/aurora.json"

# Work Log - 2025-12-24

## Summary
Two major improvement sets implemented today:
1. **Performance & Configuration Improvements** (from ImprovementsTodo.md)
2. **Holy Grail Transition Logic** (from GeminiImprovements.md)

---

## Part 1: Performance & Configuration Improvements

### Phase 6: Overlay Quality Fix
**File:** `src/overlay.py`

Fixed overlay using hardcoded quality=95 instead of config value:
```python
# Before
img.save(output_path, quality=95)

# After
output_quality = self.config.get("output", {}).get("quality", 95)
img.save(output_path, quality=output_quality)
```

### Phase 1.1: Remove Unused Config Keys
**Files:** `config/config.yml`, `config/config.example.yml`, `src/auto_timelapse.py`

Removed unused keys that were confusing:
- `transition_mode.analogue_gain_min`
- `transition_mode.analogue_gain_max`
- `transition_mode.min_exposure_time`

Fixed code to use sensible default instead of removed config:
```python
settings["AnalogueGain"] = 2.5  # Was: transition["analogue_gain_max"]
```

### Phase 1.2: Fixed Day WB Gains Config
**Files:** `config/config.yml`, `config/config.example.yml`, `src/auto_timelapse.py`

Added optional `fixed_colour_gains` to day_mode for consistent WB across sessions:
```yaml
day_mode:
  fixed_colour_gains: [2.5, 1.6]  # Optional, overrides AWB learning
```

Updated `_get_target_colour_gains()` to use priority:
1. Fixed config gains
2. Learned AWB reference
3. Default (2.5, 1.6)

### Phase 1.3: Test Shot Frequency Control
**Files:** `config/config.yml`, `config/config.example.yml`, `src/auto_timelapse.py`

Added `frequency` option to reduce test shot overhead:
```yaml
test_shot:
  frequency: 1  # 1 = every frame, 2 = every other frame, etc.
```

When skipping test shots, reuses last known mode/lux values and keeps camera running.

### Phase 2: Lores Stream for Brightness Measurement
**Files:** `src/capture_image.py`, `src/auto_timelapse.py`

Added 320×240 low-resolution stream for fast brightness measurement:

**Camera configuration:**
```python
camera_config = self.picam2.create_still_configuration(
    main={"size": resolution, "format": "RGB888"},
    lores={"size": (320, 240), "format": "RGB888"},  # NEW
    ...
)
```

**New method:** `_compute_brightness_from_lores(request)`
- Computes brightness directly from memory (no disk I/O)
- Measures BEFORE overlay is applied (no contamination)
- Same metrics as disk-based analysis

**Integration:**
```python
# Compute brightness from lores BEFORE saving
self.last_brightness_metrics = self._compute_brightness_from_lores(request)
request.save("main", str(output_path))
```

Auto-timelapse now prefers lores brightness, falls back to disk analysis.

---

## Part 2: Holy Grail Transition Logic

### Background
The "Holy Grail" approach eliminates the "flash" (exposure pop) and "color snap" (AWB shift) during sunset/sunrise transitions by seeding interpolation state from actual camera metadata.

### What Was Already Implemented
Most features were already in place:
- EMA lux smoothing (`_smooth_lux`)
- Mode hysteresis (`_apply_hysteresis`)
- Exposure/Gain/WB interpolation
- AWB disabled during transitions
- Manual exposure during transitions
- Brightness feedback

### New: Metadata Seeding (Flash Killer)
**File:** `src/auto_timelapse.py`

Added state variables:
```python
self._transition_seeded: bool = False
self._seed_exposure: float = None
self._seed_gain: float = None
self._seed_wb_gains: tuple = None
self._previous_mode: str = None
self._last_day_capture_metadata: Dict = None
```

Added `_seed_from_metadata()` method:
- Captures AWB gains from test shot (AWB is enabled during test shots)
- Captures exposure/gain from last actual day mode capture
- Seeds interpolation state so first manual frame matches last auto frame

### New: Transition Progress Logging
Added `_log_transition_progress()` method:
```
[Transition] Progress: 45% | Lux: 42.5 | Shutter: 234ms | Gain: 1.85 | AWB: Locked
```

### Integration in Run Loop
Detects mode change Day → Transition/Night:
```python
entering_manual_mode = (
    self._previous_mode == LightMode.DAY
    and mode in (LightMode.TRANSITION, LightMode.NIGHT)
)

if entering_manual_mode and not self._transition_seeded:
    self._seed_from_metadata(test_metadata, self._last_day_capture_metadata)
```

Resets seed state when returning to day mode.

---

## Documentation Updates

### Updated Files
- `docs/TRANSITION_SMOOTHING.md` - Added lores stream section, updated config examples, changelog
- `GeminiImprovements.md` - Marked as implemented with details
- `Improvements_done.md` - Created comprehensive summary

---

## Test Results
- **300 tests pass**
- 1 skipped
- Code formatted with black

---

## Config Changes Summary

### New Optional Config Keys (with defaults)
```yaml
day_mode:
  fixed_colour_gains: [2.5, 1.6]  # Optional

test_shot:
  frequency: 1  # Default: 1 (every frame)
```

### Removed Config Keys
```yaml
transition_mode:
  # REMOVED - no longer used:
  # analogue_gain_min: 1.0
  # analogue_gain_max: 2.5
  # min_exposure_time: 0.001
```

No config changes required on existing Pi systems - all new options have sensible defaults.

---

## Part 3: Transition Analysis Upgrade

### New Holy Grail Analysis Graphs

Updated `src/analyze_timelapse.py` to generate three new graphs for verifying transition smoothness:

#### 1. `holy_grail_comparison.png` - Multi-Variable Comparison Plot
- Overlays Lux, ExposureTime, and AnalogueGain on same time axis
- Uses triple Y-axis (Lux left, Exposure right, Gain far right)
- Shaded background shows mode zones (yellow=day, purple=transition, blue=night)
- **Purpose**: Verify exposure follows lux inversely with smooth S-curve (no spikes)

#### 2. `holy_grail_awb_stability.png` - AWB Gain Stability Plot
- Two-panel plot showing Red and Blue AWB gains over time
- Shaded transition zones highlight where gains should be FLAT
- Calculates and displays "jitter" (standard deviation) in transition zones
- Shows "✓ AWB LOCKED" or "⚠ AWB UNSTABLE" based on jitter < 0.01
- **Purpose**: Verify AWB lock is working (gains perfectly flat during transition)

#### 3. `holy_grail_transition_factor.png` - Transition Position Plot
- Shows transition_position value (0.0 = night threshold, 1.0 = day threshold)
- Reference lines for night/day thresholds and midpoint
- **Purpose**: Verify smooth S-curve progression, not Z-shape (sharp angles)

### Helper Function Added
```python
def find_transition_zones(timestamps, modes) -> List[Tuple[datetime, datetime, str]]:
    """Find continuous time ranges for each mode (day, night, transition)."""
```

### How to Verify a Perfect Transition
1. **holy_grail_comparison.png**: Exposure curve should mirror Lux curve inversely with smooth S-shape
2. **holy_grail_awb_stability.png**: Red/Blue gains should be perfectly flat in purple zones
3. **holy_grail_transition_factor.png**: Should show smooth S-curve, not Z-shape with sharp angles

### Test Results
- All 300 tests pass
- Code formatted with black
